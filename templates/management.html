{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Trang Quản Lý{% endblock %}
{% block css %}
    <link rel="stylesheet" href="{% static 'css/management.css' %}">
    <style>
        .product-sizes-info {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .size-badge {
            display: inline-block;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 3px;
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .size-badge.low-stock {
            background: #fff3cd;
            color: #856404;
        }

        .size-badge.out-stock {
            background: #f8d7da;
            color: #842029;
        }
    </style>
{% endblock %}

{% block content %}
    <main class="main">
        <!-- Tabs -->
        <div class="heading__manager content">
            <ul class="container__manager row">
                <li class="item__manager managerUser item__manager__active ">User</li>
                <li class="item__manager managerProduct">Product</li>
                <li class="item__manager managerOrder">Order</li>
            </ul>
        </div>

        <!-- User -->
        <div class="table__user table__wrap active">
            <!-- Input form -->
            <div class="content form__product">
                <form method="POST" action="{% url 'create_user' %}" class="form_product__wrap">
                    {% csrf_token %}
                    <div class="title__product">
                        <h1 class="title__product__wrap">User Management</h1>
                    </div>
                    <div class="form__group content">
                        <label>Username</label>
                        <input type="text" name="username" class="form__control" required>
                    </div>
                    <div class="form__group content">
                        <label>Password</label>
                        <input type="password" name="password" class="form__control" required>
                    </div>
                    <div class="form__group content">
                        <label>Confirm password</label>
                        <input type="password" name="confirm_password" class="form__control" required>
                    </div>
                    <div class="content btn__control__product">
                        <button type="submit" class="btn__add btn">Add Customer</button>
                    </div>
                </form>

                <form method="GET" action="{% url 'management' %}" class="form_product__wrap">
                    <div class="form__group content">
                        <label>Search</label>
                        <input type="text" name="search_user" class="form__control"
                               value="{{ request.GET.search_user }}">
                    </div>
                    <div class="content btn__control__product">
                        <button type="submit" class="btn__add btn">Search</button>
                    </div>
                </form>

            </div>

            <!-- List -->
            <table class="table content">
                <tr class="table__header_row">
                    <th class="table__header_col">Name User</th>
                    <th class="table__header_col">Position</th>
                    <th class="table__header_col">Edit</th>
                </tr>
                <tbody class="listUsers">
                {% for user in users %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>{% if user.is_staff %}
                            ADMIN
                        {% else %}
                            Customer
                        {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'delete_user' user.id %}"
                               onclick="return confirm('Bạn có chắc chắn muốn xóa người dùng này không?');">
                                <img src="{% static 'img/img__delete.png' %}" alt="Xoá" class="img__delete__user">
                            </a>
                            <a href="{% url 'edit_user' user.id %}">
                                <img src="{% static 'img/edit__img.jpeg' %}" alt="Cập nhật" class="img__delete__user">
                            </a>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="3">Không có user nào.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Product -->
        <div class="table__Product table__wrap unactive">
            <div class="content btn__control__product">
                <a href="{% url 'add_product' %}" class="btn__add btn">Add Product</a>
            </div>

            <div class="form__search content">
                <form method="GET" action="/management/" style="display: flex;width: 100%;">
                    <input type="text" name="search_product" id="search__product" class="search__product"
                           placeholder="Search" style="padding-left: 15px; flex: 1;"
                           value="{{ request.GET.search_product }}">
                    <button class="btn__search btn" type="submit">Search Product</button>
                </form>
            </div>

            <table class="table content">
                <tr class="table__header_row">
                    <th class="table__header_col">ID</th>
                    <th class="table__header_col">Image</th>
                    <th class="table__header_col">Name</th>
                    <th class="table__header_col">Price</th>
                    <th class="table__header_col">Sizes & Stock</th>
                    <th class="table__header_col">Edit</th>
                </tr>
                <tbody class="listProduct">
                {% for product in products %}
                    <tr>
                        <td>{{ product.id }}</td>
                        <td>
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.name }}"
                                     style="width: 60px; height: 60px; object-fit: cover;">
                            {% else %}
                                <span style="color: #999;">No image</span>
                            {% endif %}
                        </td>
                        <td>{{ product.name }}</td>
                        <td>{{ product.price|floatformat:0|intcomma }} đ</td>
                        <td>
                            <div class="product-sizes-info">
                                {% for ps in product.sizes.all %}
                                    <span class="size-badge 
                                        {% if ps.quantity == 0 %}out-stock
                                        {% elif ps.quantity < 5 %}low-stock
                                        {% endif %}">
                                        {{ ps.size.name }}: {{ ps.quantity }}
                                    </span>
                                {% empty %}
                                    <span style="color: #999;">No sizes</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <a href="{% url 'edit_product' product.id %}">
                                <img src="{% static 'img/edit__img.jpeg' %}" alt="Cập nhật" class="img__delete__user">
                            </a>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" style="text-align:center;">Không có sản phẩm nào</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- order -->
        <div class="table__order table__wrap unactive" onload="showOrdersList()">
            <div class="search-order">
                <div class="search-order-tittle">BẢNG TRA CỨU</div>
                <div class="search-order-input">
                    <input
                            type="text"
                            name="id-order"
                            id="id-order"
                            placeholder="Nhập mã đơn hàng"
                    />
                    <input type="date" name="date-order" id="date-order"/>
                    <select name="date-around" id="date-around">
                        <option value="7">Tuần này</option>
                        <option value="30">Tháng này</option>
                        <option value="365">Năm này</option>
                    </select>
                </div>
                <button onclick="searchOrder()">Tra cứu</button>
                <button onclick="statis(); updateStatis()">Bảng thống kê</button>
            </div>
            <table class="table content table--order">
                <tr class="table__header_row">
                    <th class="table__header_col id-order">ID Order</th>
                    <th class="table__header_col name-user">Receiver</th>
                    <th class="table__header_col info">Details</th>
                    <th class="table__header_col price">Total Price</th>
                    <th class="table__header_col date">Date</th>
                    <th class="table__header_col accept">Address</th>
                    <th class="table__header_col accept">Status</th>
                    <th class="table__header_col interupt">Actions</th>
                </tr>
                <tbody class="listOrders">
                {% for order in orders %}
                    <tr>
                        <td>{{ order.id }}</td>
                        <td>{{ order.receiver }}</td>

                        <!-- Details -->
                        <td>
                            {% for item in order.items.all %}
                                <p>{{ item }}</p>
                            {% endfor %}
                        </td>

                        <td>{{ order.total_amount|floatformat:0|intcomma }} đ</td>
                        <td>{{ order.created_at|date:"d/m/Y H:i" }}</td>
                        <td>{{ order.address }}</td>
                        <td>
                            <span class="accepted-label status-{{ order.status }}">
                                {{ order.get_status_display }}
                            </span>
                        </td>
                        <td>
                            {% if order.status == "pending" %}
                                <a href="">
                                    <button class="btn-accept" onclick="acceptOrder({{ order.id }})">Accept</button>
                                </a>
                            {% endif %}
                            {% if order.status == "pending" or order.status == "confirmed" %}
                                <a href=""
                                   onclick="return confirm('Bạn có chắc chắn muốn hủy đơn hàng này không?');">
                                    <button class="btn-interrupt" onclick="cancelOrder({{ order.id }})">Cancel</button>
                                </a>
                            {% endif %}
                        </td>
                    </tr>

                {% empty %}
                    <tr>
                        <td colspan="8" style="text-align:center;">
                            Không có đơn hàng nào.
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="block__deletePoduct unactive">
            <div class="block__deletePoduct__wrap">
                <h1 class="block__deletePoduct__title">
                    Do you want to Delete Product?
                </h1>
                <div class="btn__block__deletePoduct row content">
                    <button class="btn__cancle__deletePoduct">Cancle</button>
                    <button class="btn__deletePoduct">Delete</button>
                </div>
            </div>
        </div>
        <div class="statistics modal" style="display: none">
            <div class="statis">
                <div class="cancel-statis" onclick="cancelStatis()">×</div>
                <div class="title">
                    <span>Thống kê</span>
                </div>
                <div class="name-product">
                    <div class="name-product-left">
                        <p>Tên</p>
                    </div>
                    <div class="name-product-right">
                        <div class="total-statis">
                            Doanh thu 7 ngày:
                            <span class="total-statis-price"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    {% if messages %}
        <script>
            {% for message in messages %}
                alert("{{ message|escapejs }}");
            {% endfor %}
        </script>
    {% endif %}

    <script>
        setActiveNav('admin');
    </script>

    <script src="{% static 'js/admin/main.js' %}"></script>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        function searchOrder() {
            const orderId = document.getElementById('id-order').value.trim();
            const dateOrder = document.getElementById('date-order').value;
            const dateRange = document.getElementById('date-around').value;

            const params = new URLSearchParams();
            if (orderId) params.append('order_id', orderId);
            if (dateOrder) params.append('date', dateOrder);
            if (dateRange) params.append('date_range', dateRange);

            fetch(`/orders/api/search/?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateOrdersTable(data.orders);
                        if (data.orders.length === 0) {
                            alert('Không tìm thấy đơn hàng phù hợp!');
                        }
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Lỗi tra cứu:', error);
                    alert('Có lỗi xảy ra khi tra cứu đơn hàng!');
                });
        }

        function statis() {
            const dateRange = document.getElementById('date-around').value;

            fetch(`/orders/api/statistics/?date_range=${dateRange}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayStatistics(data.stats);
                    } else {
                        alert('Không thể tải thống kê: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Lỗi thống kê:', error);
                    alert('Có lỗi xảy ra khi tải thống kê!');
                });
        }

        function updateStatis() {}

        function displayStatistics(stats) {
            const modal = document.querySelector('.statistics');
            const nameProduct = modal.querySelector('.name-product');

            nameProduct.innerHTML = `
                <div class="name-product-left">
                    <p><strong>Tổng đơn hàng:</strong> ${stats.total_orders}</p>
                    <p><strong>Chờ xác nhận:</strong> ${stats.pending_orders}</p>
                    <p><strong>Đã xác nhận:</strong> ${stats.confirmed_orders}</p>
                    <p><strong>Đang giao:</strong> ${stats.shipping_orders}</p>
                    <p><strong>Hoàn thành:</strong> ${stats.completed_orders}</p>
                    <p><strong>Đã hủy:</strong> ${stats.cancelled_orders}</p>
                </div>
                <div class="name-product-right">
                    <div class="total-statis">
                        Doanh thu ${stats.date_range_days} ngày qua:
                        <span class="total-statis-price">${formatCurrency(stats.total_revenue)}</span>
                    </div>
                </div>
            `;

            modal.style.display = 'block';
        }

        function cancelStatis() {
            document.querySelector('.statistics').style.display = 'none';
        }

        function acceptOrder(orderId) {
            if (!confirm('Bạn có chắc chắn muốn chấp nhận đơn hàng này?')) {
                return;
            }

            fetch(`/orders/api/${orderId}/accept/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Lỗi:', error);
                    alert('Có lỗi xảy ra!');
                });
        }

        function cancelOrder(orderId) {
            const reason = prompt('Vui lòng nhập lý do hủy đơn hàng:');

            if (!reason || reason.trim() === '') {
                alert('Bạn phải nhập lý do để hủy đơn hàng!');
                return;
            }

            if (!confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')) {
                return;
            }

            fetch(`/orders/api/${orderId}/cancel/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ reason: reason })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Lỗi:', error);
                    alert('Có lỗi xảy ra!');
                });
        }

        function updateOrdersTable(orders) {
            const tbody = document.querySelector('.listOrders');
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align:center;">Không có đơn hàng nào.</td>
                    </tr>
                `;
                return;
            }

            orders.forEach(order => {
                const row = document.createElement('tr');
                const itemsHtml = order.items.map(item =>
                    `<p>${item.name} ${item.size} x ${item.quantity}</p>`
                ).join('');

                let actionsHtml = '';
                if (order.status === 'pending') {
                    actionsHtml = `
                        <button class="btn-accept" onclick="acceptOrder(${order.id})">Accept</button>
                        <button class="btn-interrupt" onclick="cancelOrder(${order.id})">Cancel</button>
                    `;
                } else if (order.status === 'confirmed') {
                    actionsHtml = `
                        <button class="btn-interrupt" onclick="cancelOrder(${order.id})">Cancel</button>
                    `;
                }

                row.innerHTML = `
                    <td>${order.id}</td>
                    <td>${order.receiver}</td>
                    <td>${itemsHtml}</td>
                    <td>${formatCurrency(order.total_amount)}</td>
                    <td>${order.created_at}</td>
                    <td>${order.address}</td>
                    <td><span class="accepted-label status-${order.status}">${order.status_display}</span></td>
                    <td>${actionsHtml}</td>
                `;

                tbody.appendChild(row);
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount) + ' đ';
        }
    </script>
{% endblock %}