{% extends "base.html" %}
{% load static %}

{% block title %}Gi·ªè h√†ng - Fashion Shop{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block content %}
<div class="cart-container">
    <h1 class="cart-title">Gi·ªè h√†ng</h1>
    
    <div class="cart-content">
        <div class="cart-items" id="cartItems">
            <div class="cart-empty">
                <div class="cart-empty-icon">üõí</div>
                <p>Gi·ªè h√†ng c·ªßa b·∫°n tr·ªëng</p>
                <div class="continue-shopping">
                    <a href="{% url 'home' %}">Ti·∫øp t·ª•c mua s·∫Øm</a>
                </div>
            </div>
        </div>
        
        <div class="cart-summary">
            <h3 class="summary-title">T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
            
            <div class="summary-row">
                <span>T·∫°m t√≠nh:</span>
                <span id="subtotal">0ƒë</span>
            </div>
            
            <div class="summary-row">
                <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                <span>Mi·ªÖn ph√≠</span>
            </div>
            
            <div class="summary-row total">
                <span>T·ªïng c·ªông:</span>
                <span id="totalPrice">0ƒë</span>
            </div>
            
            <button class="checkout-btn" id="checkoutBtn" onclick="goToCheckout()">
                Ti·∫øp t·ª•c thanh to√°n
            </button>
            
            <div class="continue-shopping">
                <a href="{% url 'home' %}">Ti·∫øp t·ª•c mua s·∫Øm</a>
            </div>
        </div>
    </div>
</div>

<script>
// LocalStorage Cart Manager
class CartManager {
    constructor() {
        this.storageKey = 'fashionshop_cart';
        this.loadCart();
    }
    
    loadCart() {
        const cart = localStorage.getItem(this.storageKey);
        return cart ? JSON.parse(cart) : [];
    }
    
    saveCart(cart) {
        localStorage.setItem(this.storageKey, JSON.stringify(cart));
    }
    
    addItem(item) {
        const cart = this.loadCart();
        const existingItem = cart.find(i => 
            i.product_id === item.product_id && 
            i.product_size_id === item.product_size_id
        );
        
        if (existingItem) {
            existingItem.quantity += item.quantity;
        } else {
            cart.push(item);
        }
        this.saveCart(cart);
    }
    
    removeItem(productId, productSizeId) {
        let cart = this.loadCart();
        cart = cart.filter(i => !(i.product_id === productId && i.product_size_id === productSizeId));
        this.saveCart(cart);
    }
    
    updateQuantity(productId, productSizeId, quantity) {
        const cart = this.loadCart();
        const item = cart.find(i => 
            i.product_id === productId && 
            i.product_size_id === productSizeId
        );
        
        if (item) {
            item.quantity = Math.max(1, quantity);
            this.saveCart(cart);
        }
    }
    
    getCart() {
        return this.loadCart();
    }
    
    clearCart() {
        localStorage.removeItem(this.storageKey);
    }
}

const cart = new CartManager();

function formatPrice(price) {
    return price.toLocaleString('vi-VN') + 'ƒë';
}

function renderCart() {
    const cartItems = cart.getCart();
    const container = document.getElementById('cartItems');
    
    if (cartItems.length === 0) {
        container.innerHTML = `
            <div class="cart-empty">
                <div class="cart-empty-icon">üõí</div>
                <p>Gi·ªè h√†ng c·ªßa b·∫°n tr·ªëng</p>
                <div class="continue-shopping">
                    <a href="{% url 'home' %}">Ti·∫øp t·ª•c mua s·∫Øm</a>
                </div>
            </div>
        `;
        updateSummary([]);
        return;
    }
    
    let html = '';
    cartItems.forEach(item => {
        const image = item.image || '/placeholder.svg?height=100&width=100';
        const itemTotal = item.price * item.quantity;
        
        html += `
            <div class="cart-item">
                <div class="cart-item-image">
                    <img src="${image}" alt="${item.product_name}">
                </div>
                <div class="cart-item-info">
                    <h3>${item.product_name}</h3>
                    <p>Size: ${item.size_name}</p>
                    <p>Gi√°: ${formatPrice(item.price)}</p>
                </div>
                <div class="cart-item-actions">
                    <div class="cart-item-quantity">
                        <button onclick="changeQuantity(${item.product_id}, ${item.product_size_id}, -1)">‚àí</button>
                        <input type="number" value="${item.quantity}" readonly>
                        <button onclick="changeQuantity(${item.product_id}, ${item.product_size_id}, 1)">+</button>
                    </div>
                    <div class="cart-item-price">${formatPrice(itemTotal)}</div>
                    <button class="cart-item-delete" onclick="removeFromCart(${item.product_id}, ${item.product_size_id})">√ó</button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    updateSummary(cartItems);
}

function changeQuantity(productId, productSizeId, change) {
    const cartItems = cart.getCart();
    const item = cartItems.find(i => 
        i.product_id === productId && 
        i.product_size_id === productSizeId
    );
    
    if (item) {
        item.quantity = Math.max(1, item.quantity + change);
        cart.updateQuantity(productId, productSizeId, item.quantity);
        renderCart();
    }
}

function removeFromCart(productId, productSizeId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
        cart.removeItem(productId, productSizeId);
        renderCart();
    }
}

function updateSummary(cartItems) {
    const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    document.getElementById('subtotal').textContent = formatPrice(subtotal);
    document.getElementById('totalPrice').textContent = formatPrice(subtotal);
    document.getElementById('checkoutBtn').disabled = cartItems.length === 0;
}

function goToCheckout() {
    const cartItems = cart.getCart();
    if (cartItems.length === 0) {
        alert('Gi·ªè h√†ng c·ªßa b·∫°n tr·ªëng');
        return;
    }
    window.location.href = '{% url "checkout" %}';
}

// Render cart on page load
document.addEventListener('DOMContentLoaded', renderCart);
</script>
{% endblock %}
